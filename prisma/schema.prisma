generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
   url      = env("DATABASE_URL")
}

enum EngagementBucket {
  LEAD
  DEAL
  ACCOUNT
}

enum DealStage {
  DISCOVERY
  DEMO
  PROPOSAL
  ON_HOLD
  CLOSED_WON
  CLOSED_LOST
}

enum AccountStatus {
  ACTIVE
  FORMER
}

enum TaskStatus {
  OPEN
  DONE
}

enum TaskType {
  CALL
  EMAIL
  MEETING
  INTERNAL
}

enum ActivityType {
  EMAIL_OUT
  EMAIL_IN
  CALL
  MEETING
  NOTE
}

model Company {
  id        String    @id @default(cuid())
  name      String
  website   String?
  industry  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  contacts     Contact[]
  engagements  Engagement[]

  @@index([name])
}

model Contact {
  id        String    @id @default(cuid())
  fullName  String
  email     String?
  phone     String?
  title     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  companyId String?
  company   Company?  @relation(fields: [companyId], references: [id], onDelete: SetNull)

  primaryEngagements Engagement[] @relation("PrimaryContactEngagements")
  activities         Activity[]
}

model Engagement {
  id                String           @id @default(cuid())
  prototypeSource   String?
  prototypeKey      String?
  bucket            EngagementBucket
  product           String?
  source            String?
  notes             String?
  nextStep          String?
  followUpRequired  Boolean          @default(false)
  lastTouchAt       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Deal-only fields (nullable unless bucket=DEAL)
  dealStage         DealStage?
  meetingScheduledAt DateTime?
  closeDateTarget   DateTime?
  value             Float?

  // Account-only fields (nullable unless bucket=ACCOUNT)
  accountStatus     AccountStatus?
  billingSchedule   String?
  contractStart     DateTime?
  contractEnd       DateTime?

  companyId         String
  company           Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  primaryContactId  String?
  primaryContact    Contact?         @relation("PrimaryContactEngagements", fields: [primaryContactId], references: [id], onDelete: SetNull)

  tasks             Task[]
  activities        Activity[]

  @@index([bucket])
  @@index([dealStage])
  @@index([lastTouchAt])
  @@unique([prototypeSource, prototypeKey])
}

model Task {
  id           String     @id @default(cuid())
  title        String
  dueAt        DateTime
  status       TaskStatus @default(OPEN)
  type         TaskType   @default(INTERNAL)
  priority     Int?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  engagementId String
  engagement   Engagement @relation(fields: [engagementId], references: [id], onDelete: Cascade)

  @@index([dueAt])
  @@index([status])
}

model Activity {
  id              String       @id @default(cuid())
  type            ActivityType
  occurredAt      DateTime
  subject         String?
  snippet         String?
  externalMessageId String?
  metadata        Json?
  createdAt       DateTime     @default(now())

  engagementId    String
  engagement      Engagement   @relation(fields: [engagementId], references: [id], onDelete: Cascade)

  contactId       String?
  contact         Contact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@index([occurredAt])
  @@index([type])
  @@index([externalMessageId])
}